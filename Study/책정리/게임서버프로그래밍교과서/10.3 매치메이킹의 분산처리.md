### 10.3 매치메이킹 분산처리 

멀티 게임에서 서로 다른 플레이어 간 대전이나 협력 플레이를 위해, 다른 유저들을 찾아 모으기 마련이다. 이를 매치메이킹이라 합니다.  일반적으로 이러한 일을 담당하는 서버를 로비 서버라고 합니다. 이번에는 매치메이킹을 담당하는 로비 서버의 분산처리를 알아봅시다.



1. 먼저 매치메이킹 사용자 시나리오, 즉 유즈 케이스(use case) 를 준비합니다. 게임 기획자가 주기도 합니다.



 ![SoWkIImgAStDuU8g038oapCB4lDA599pCbFpIWnHn9p1OaRnXWOemi6fHMMfHLnSN50z2hfsK345AmL3lLURUjxCQtdJFUVDl8blvhOelEvfUBLZWo8NmZGK3KOuDK2L01N3BB9ICDPJW2X_lM6bmflbBM_cjIAfGxB2Ii44YrA7rBmKeDS1 (300×214)](https://www.plantuml.com/plantuml/img/SoWkIImgAStDuU8g038oapCB4lDA599pCbFpIWnHn9p1OaRnXWOemi6fHMMfHLnSN50z2hfsK345AmL3lLURUjxCQtdJFUVDl8blvhOelEvfUBLZWo8NmZGK3KOuDK2L01N3BB9ICDPJW2X_lM6bmflbBM_cjIAfGxB2Ii44YrA7rBmKeDS1) 

```
매치메이킹 대기하는 플레이어가 열 명 모두 모였으므로 
게임 방을 만들고 플레이어들에게 게임방에 들어오라고 지시하자
```



매치메이킹 처리

1. 게임을 플레이하려는 플레이어는 게임 시작 누르고 대기
2. 플레이어와 비슷한 실력이 비슷한 다른 플레이어 아홉 명이 게임 시작하기 누르면 매칭 성공이다. 대기를 멈추고 매칭 준비를 합니다.
3. 매칭 성공 후 플레이어 열 명이 플레이가 가능한 방을 만듭니다.
4. 게임방에서 플레이어들이 채팅으로 작전 회의. 게임 시작

게임 방에서는 플레이어 메시지를 받아 처리하고, 게임방 안에서 게임 월드 시뮬레이션을 실행



분산 서버를 설계할 때 절차 생각!

1. 단일 서버 과부하 지점 찾기
2. 과부하 지점을 중심으로 분산 서버를 설계합니다.



서버 한 대가 매치메이킹과 게임방 처리 담당하면

동접늘어나면 다음 현상 발생

* 게임 방 안의 월드 시뮬레이션을 위한 서버 CPU 과부하
* 매치메이킹에 동접 몰릴 경우 서버 CPU , 램 사용량 과부하

성능을 분석 해 보면 -> 게임 전투 플레이 처리하는 곳이 비중이 크다. 매치메이킹을 위한 연산량 보다 게임방 안 월드 시뮬레이션과 대량의 네트워크 메시지를 처리하는 연산량이 훨씬 많기 때문입니다.,



따라서 게임방 처리를 분산하는 것이 우선!

게임방 처리를 따로 담당할 서버가 필요, 서버 한대에서 이를 하기 버겁다.



응집도 관점에서 살펴보자 한 게임방 안에서 플레이어들은 잦은 상호 작용합니다.

한 게임 방 에서 플레이어들은 잦은 상호작용 즉 방 안에 있는 플레이어 끼리는 데이터 응집력 높고, 서로 다른 방에 있는 플레이어끼리는 응집력이 없습니다. 따라서 게임 서버에서 게임방 처리를 여러 서버로 분산시켜야 합니다. 게임방을 처리하는 서버를 배틀 서버라고 합시다.



그래서 로비서버 한대 배틀 서버 여러대 로 나누면, 매치메이킹 후 멀티플레이 중 레이턴시를 줄일 수 있다.

배틀 서버를 여러 리전으로 나누어 놓으면 이것이 가능



로비 서버 클러스터를 한 리전에 두고 배틀 서버들은 여러 리전에 흩어 놓자. 매치메이킹을 할 때는 가까운 리전에 있는 플레이어 끼리 매칭해줍니다. 그러면 플레이어들은 가까운 리전의 배틀 서버와 통신하기 때문에 그만큼 네트워크 레이턴시가 줄어듭니다.



로비 서버 클러스터를 여러 리전에 안둔 이유는 레이턴시에 민감하지 않기 때문입니다. 

배틀 서버가 FPS 게임이면 50밀리초와 100밀리초는 현저하게 플레이 차이가 난다. 하지만 로비 서버의 채팅이나 매치메이킹 대기 시간이 50밀리초일 때와 400밀리초일 때 차이는 크기 못느낌.

1. 클라 매칭중일 때는 로비와 접속 유지
2. 매칭 완료되어 게임방을 만들 때 가장 접속자 적은 배틀 서버에 접속 이때 매칭 서버와 연결 끊는 것을 권장
3. 게임방 즐기고, 게임 끝난 후에 클라는 다시 매치메이킹을 하기 위해 로비 서버로 돌아옵니다.